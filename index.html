<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>stream</title>

<link href="https://vjs.zencdn.net/8.19.1/video-js.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/gh/onigetoc/videojs-unmute@main/src/videojs-unmute.min.css" rel="stylesheet">
<script src="https://vjs.zencdn.net/8.19.1/video.min.js"></script>
<script src="https://unpkg.com/@videojs/http-streaming@3.2.0/dist/videojs-http-streaming.min.js"></script>
<script src="https://unpkg.com/videojs-contrib-quality-levels@4.1.0/dist/videojs-contrib-quality-levels.min.js"></script>
<script src="https://unpkg.com/videojs-contrib-quality-menu@1.0.3/dist/videojs-contrib-quality-menu.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/onigetoc/videojs-unmute@main/src/videojs-unmute.min.js"></script>

</head>
<body bgcolor="#181a1b">
 <div style="display: flex">
  <video-js
        id="video"
        class="vjs-default-skin"
        type="application/x-mpegURL"
        width="1280"
        height="720"
	preload="auto"
        controls
	autoplay
	muted>
	  <track kind='chapters' srclang='en' label='Chapters' default='true' id='chapters' />
  </video-js>
 </div>

  <script>
	const slug = document.location.search.substr(1);
//	const qualButtons = document.getElementById("qualSet").getElementsByTagName("button");
//	for (var i = 0; i<qualButtons.length; i++) {
//		var button = qualButtons[i];
//		fetch("./" + slug + button.value + ".m3u8").then(function(response){
//			console.log(response);
//			if (response.ok) button.style.display = "inline";
//		});
//	}
	const chaptersEl = document.getElementById("chapters");
	chaptersEl.src = "./hls/" + slug + "/chapters.vtt";
	var quality = "1080p";
	if (!localStorage.getItem("quality:" + slug)) {
		localStorage.setItem("quality:" + slug, quality);
	} else {
		quality = localStorage.getItem("quality:" + slug);
	}
	function qualSet(button) {
		document.getElementById("q" + quality).innerText = quality;
		quality = button.value;
		localStorage.setItem("quality:" + slug, quality);
		player = videojs.getPlayer("video");
		player.src({src: "./" + slug + quality + ".m3u8", type: "application/x-mpegURL"});
		player.currentTime(localStorage.getItem("timestamp:" + slug));
		player.muted(false);
		document.getElementById("q" + quality).innerText = ">" + quality + "<";
	}

	var player = videojs('video', {
		enableSmoothSeeking: true,
		playbackRates: [0.5, 1, 1.5, 2],
		controlBar: {
			skipButtons: {
				forward: 5,
				backward: 5
			}
		},
		userActions: {
			hotkeys: function(event) {
				switch (event.key) {
					case 'f':
						if (player.isFullScreen()) {
							player.exitFullScreen();
						} else {
							player.requestFullScreen();
						}
						break;
					case 'm':
						player.muted(!player.muted());
						break;
					case ' ':
					case 'k':
						if (player.paused()) {
							player.play();
						} else {
							player.pause();
						}
						break;
					case ',':
						player.pause();
						player.currentTime(player.currentTime()-(1/29.97));
						break;
					case '.':
						player.pause();
						player.currentTime(player.currentTime()+(1/29.97));
						break;
					case 'j':
						player.currentTime(player.currentTime()-10);
						break;
					case 'l':
						player.currentTime(player.currentTime()+10);
						break;
					case 'ArrowLeft':
						player.currentTime(player.currentTime()-5);
						break;
					case 'ArrowRight':
						player.currentTime(player.currentTime()+5);
						break;
					case 'ArrowUp':
						player.volume(player.volume()+.1);
						break;
					case 'ArrowDown':
						player.volume(player.volume()+.1);
						break;
				}
			}
		},
		spatialNavigation: {
			enabled: true,
			horizontalSeek: true
		},
		plugins: {
			qualityMenu: {
				defaultResolution: '1080'
			}
		}
	}, function () {
		var player = this;
		var bpb = player.getChild('bigPlayButton');
		bpb.hide();
		player.unmuteButton();
		player.el().focus();
		this.on('timeupdate', function() {
			localStorage.setItem("timestamp:" + slug, this.currentTime());
		});
		player.src({src: "./hls/" + slug + "/master.m3u8", type: "application/x-mpegURL"});
		player.currentTime(localStorage.getItem("timestamp:" + slug));

		var promise = player.play();
		if (promise === undefined) {
			console.log("Autoplay promise ignored");
			bpb.show();
		} else {
			promise.then(function() {
				console.log("Autoplay promise success");
				bpb.show();
			}, function(e) {
				console.error(e);
				bpb.show();
			});
		}
	});
  </script>

</body>
</html>
